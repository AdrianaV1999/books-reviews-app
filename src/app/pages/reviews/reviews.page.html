<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button
        defaultHref="/home"
        text=""
        color="light"
        class="small-back-button"
      ></ion-back-button>
    </ion-buttons>
    <ion-title>Reviews</ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="logout()">
        <i
          class="fa fa-sign-out-alt"
          style="color: #ff8787; font-size: 1.05rem; margin-right: 6px"
        ></i>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-list *ngIf="reviews.length > 0">
    <ion-list-header color="light" mode="md">
      <ion-label> {{ reviews.length }} Reviews </ion-label>
      <div
        style="
          text-align: right;
          margin-right: 20px;
          margin-bottom: 10px;
          margin-top: 10px;
        "
      >
        <label for="sortSelect">Sort by: </label>
        <select id="sortSelect" [(ngModel)]="sortBy" (change)="onSortChange()">
          <option value="date">Date</option>
          <option value="rate">Rating</option>
        </select>
      </div>
    </ion-list-header>

    <ion-item *ngFor="let review of reviews">
      <ion-thumbnail
        slot="start"
        *ngIf="review.thumbnail"
        class="book-thumbnail"
        (click)="openDetailsModal(review)"
      >
        <img [src]="review.thumbnail" alt="Book cover" />
      </ion-thumbnail>

      <ion-label>
        <strong>{{ review?.bookTitle }}</strong>
        <br />
        <small>by {{ review?.bookAuthors?.join(', ') }}</small>
        <br />

        <app-star-rating
          [initialRating]="review?.rate"
          [readonly]="true"
          [alignment]="'left'"
          [size]="'0.9rem'"
        ></app-star-rating>

        <p>
          <ion-text>
            <p>{{ review.createdAt?.toDate() | date:'medium' }}</p>
          </ion-text>
        </p>
      </ion-label>

      <ion-buttons slot="end">
        <ion-button color="primary" fill="clear" (click)="updateReview(review)">
          <ion-icon slot="icon-only" name="create-outline"></ion-icon>
        </ion-button>
        <ion-button
          color="danger"
          fill="clear"
          (click)="deleteReview(review.id)"
        >
          <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
        </ion-button>
      </ion-buttons>
    </ion-item>
  </ion-list>

  <ion-fab slot="fixed" horizontal="end" vertical="bottom">
    <ion-fab-button [routerLink]="['/books']">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>

  <ion-modal
    #rate_modal
    trigger="open-modal"
    [initialBreakpoint]="0.75"
    [breakpoints]="[0, 0.25, 0.5, 0.75, 0.9]"
    (willDismiss)="onWillDismiss($event)"
  >
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-buttons slot="start">
            <ion-button (click)="dismiss()" color="danger">Cancel</ion-button>
          </ion-buttons>
          <ion-title>REVIEW</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="dismiss(true)" [strong]="true" color="primary">
              SAVE
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding">
        <ion-row>
          <ion-col size="12" class="ion-text-center">
            <ion-label color="dark" class="ion-text-wrap">
              Please provide your valuable feedback ?
            </ion-label>
          </ion-col>

          <ion-col size="12" class="rate">
            <app-star-rating
              [initialRating]="rating.rate"
              (ratingChange)="rating.rate = $event"
            ></app-star-rating>
          </ion-col>

          <ion-col size="12">
            <ion-textarea
              label=""
              rows="2"
              placeholder="Any Comments (optional)"
              [(ngModel)]="rating.comment"
            ></ion-textarea>
          </ion-col>
        </ion-row>

        <ion-toast
          [isOpen]="isToastOpen"
          [message]="errorMessage"
          [duration]="3000"
          color="danger"
          (didDismiss)="setOpen(false)"
        ></ion-toast>
      </ion-content>
    </ng-template>
  </ion-modal>

  <ion-modal
    #details_modal
    [initialBreakpoint]="0.75"
    [breakpoints]="[0, 0.25, 0.5, 0.75, 0.9]"
    (willDismiss)="onDetailsDismiss()"
  >
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-buttons slot="start">
            <ion-button (click)="closeDetailsModal()" color="danger"
              >Close</ion-button
            >
          </ion-buttons>
          <ion-title>Review Details</ion-title>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding">
        <div class="ion-text-center">
          <img
            *ngIf="selectedReview?.thumbnail"
            [src]="selectedReview?.thumbnail"
            alt="Book cover"
            style="max-width: 150px; border-radius: 8px"
          />
          <h2>{{ selectedReview?.bookTitle }}</h2>
          <p>
            <strong>Authors:</strong> {{ selectedReview?.bookAuthors?.join(', ')
            }}
          </p>
          <app-star-rating
            [initialRating]="selectedReview?.rate"
            [readonly]="true"
          ></app-star-rating>
          <p>
            <strong>Date:</strong> {{ selectedReview?.createdAt?.toDate() |
            date:'medium' }}
          </p>
          <p *ngIf="selectedReview?.comment">
            <strong>Comment:</strong> {{ selectedReview?.comment }}
          </p>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
